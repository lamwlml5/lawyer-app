<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المستشار أحمد الألفي - نظام الإدارة القانونية الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .input-box {
            background-color: #1e293b;
            border: 1px solid #334155;
            transition: all 0.2s ease;
        }
        .input-box:focus-within {
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
        }
        .tab-button-active {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            border-color: #f59e0b !important;
        }
        .nav-active {
            color: #f59e0b;
        }
        .animate-ring {
            animation: ring 2s infinite ease-in-out;
        }
        @keyframes ring {
            0% { transform: rotate(0); }
            10% { transform: rotate(15deg); }
            20% { transform: rotate(-15deg); }
            30% { transform: rotate(10deg); }
            40% { transform: rotate(-10deg); }
            50% { transform: rotate(0); }
            100% { transform: rotate(0); }
        }
        input, select, textarea {
            appearance: none;
            color-scheme: dark;
        }
        .case-card {
            background-color: #1e293b;
            border-radius: 2rem;
            padding: 1.5rem;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .case-card:active {
            transform: scale(0.98);
        }
        .card-accent {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
        }

        @media print {
            body { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page { 
                padding: 1.5cm; 
                page-break-after: always; 
                direction: rtl; 
                font-family: 'Cairo', sans-serif;
                color: black !important;
            }
            .print-header {
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 15px;
                margin-bottom: 30px;
            }
            .print-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
            .print-item {
                border-bottom: 1px solid #ddd;
                padding: 10px 5px;
                display: flex;
                gap: 10px;
            }
            .print-label { font-weight: 900; min-width: 120px; color: #333; }
            .image-page {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                page-break-before: always;
                padding: 1cm;
            }
            .image-page img {
                max-width: 100%;
                max-height: 95%;
                object-fit: contain;
                border: 1px solid #eee;
            }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="pb-28">

    <!-- نظام التنبيه الفوري -->
    <div id="alarm-banner" class="fixed top-4 left-4 right-4 z-[300] bg-gradient-to-r from-red-600 to-amber-600 text-white p-5 rounded-3xl shadow-2xl hidden flex items-center gap-4 border border-white/20 animate-bounce no-print">
        <div class="bg-white/20 p-3 rounded-2xl animate-ring">
            <i data-lucide="bell-ring" class="w-7 h-7"></i>
        </div>
        <div class="flex-1">
            <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">تذكير قانوني هام</p>
            <p id="alarm-text" class="text-sm font-black leading-tight"></p>
        </div>
        <button onclick="dismissAlarm()" class="bg-black/20 p-2 rounded-full">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="p-6 flex items-center justify-between sticky top-0 bg-[#020617]/80 backdrop-blur-lg z-[50] border-b border-slate-800 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-amber-600 p-2.5 rounded-2xl shadow-lg shadow-amber-900/40">
                <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tight">المستشار أحمد الألفي</h1>
                <p class="text-[9px] text-amber-500 font-bold uppercase tracking-wider">نظام الإدارة القانونية الذكي</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button onclick="exportDatabase()" title="تصدير نسخة احتياطية" class="bg-slate-800 p-3 rounded-2xl border border-slate-700 shadow-xl active:scale-90 transition-transform">
                <i data-lucide="download" class="w-5 h-5 text-emerald-500"></i>
            </button>
            <label class="bg-slate-800 p-3 rounded-2xl border border-slate-700 shadow-xl active:scale-90 transition-transform cursor-pointer">
                <i data-lucide="upload" class="w-5 h-5 text-blue-500"></i>
                <input type="file" class="hidden" accept=".json" onchange="importDatabase(event)">
            </label>
            <button onclick="handleHeaderButtonClick()" class="bg-[#1e293b] p-3 rounded-2xl border border-slate-700 shadow-xl active:scale-90 transition-transform">
                <i data-lucide="plus" id="header-icon" class="w-6 h-6 text-amber-500 transition-all"></i>
            </button>
        </div>
    </header>

    <main class="px-5 mt-6 no-print">
        <!-- اختيار التصنيف الرئيسي -->
        <div class="flex gap-2 mb-6 bg-slate-900/50 p-1 rounded-2xl border border-slate-800">
            <button onclick="switchCategory('cases')" id="cat-cases" class="flex-1 py-3 rounded-xl text-xs font-black transition-all bg-amber-600 text-white shadow-lg">القضايا</button>
            <button onclick="switchCategory('reports')" id="cat-reports" class="flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-500">المحاضر</button>
        </div>

        <!-- Search Area -->
        <div id="search-area" class="mb-6">
            <div class="relative">
                <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 w-5 h-5"></i>
                <input type="text" id="searchInput" oninput="renderDisplay()" placeholder="ابحث في السجلات..." 
                       class="w-full bg-[#1e293b] border border-slate-800 rounded-2xl py-4 pr-12 pl-4 outline-none text-sm font-bold shadow-inner text-center">
            </div>
        </div>

        <!-- Content Section -->
        <div id="list-section">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 id="current-view-title" class="text-xs font-black text-slate-500 uppercase tracking-widest">السجلات الحالية</h2>
                <span id="items-count" class="bg-slate-800 text-amber-500 px-3 py-1 rounded-full text-[10px] font-bold">0 سجل</span>
            </div>
            <div id="cards-container" class="space-y-4"></div>
        </div>

        <!-- Form Section -->
        <div id="add-section" class="hidden pb-10 space-y-6">
            <div id="case-fields" class="space-y-4">
                <h2 class="text-amber-500 text-xs font-black flex items-center gap-2 mb-2">
                    <i data-lucide="gavel" class="w-4 h-4"></i> بيانات الدعوى
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">رقم القضية</label><input type="text" id="caseNumber" placeholder="رقم القضية" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">رقم الحصر</label><input type="text" id="hasrNumber" placeholder="رقم الحصر" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                </div>
                <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">رقم الاستئناف</label><input type="text" id="appealNumber" placeholder="رقم الاستئناف إن وجد" class="w-full bg-transparent outline-none text-sm font-bold text-center text-blue-400"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">المحكمة</label><input type="text" id="court" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">الدائرة</label><input type="text" id="circuit" placeholder="رقم الدائرة" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                </div>
            </div>

            <div id="report-fields" class="hidden space-y-4">
                <h2 class="text-blue-500 text-xs font-black flex items-center gap-2 mb-2">
                    <i data-lucide="file-text" class="w-4 h-4"></i> بيانات  العريضة / المحضر
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">رقم العريضة</label><input type="text" id="reportAridatNum" placeholder="رقم العريضة" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">تاريخ العريضة</label><input type="date" id="reportAridatDate" class="w-full bg-transparent outline-none text-xs font-bold text-center"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-box rounded-2xl p-3">
                        <label class="block text-[9px] text-slate-500 mb-1">نوع المحضر</label>
                        <input type="text" id="reportTypeInput" placeholder="إداري، جنح..." class="w-full bg-transparent outline-none text-sm font-bold text-center">
                    </div>
                    <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">الرقم القضائي</label><input type="text" id="reportLegalNum" placeholder="الرقم القضائي" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                </div>
                <div class="input-box rounded-2xl p-3">
                    <label class="block text-[9px] text-slate-500 mb-1">قرار النيابة</label>
                    <select id="reportNiyabaDecision" class="w-full bg-transparent outline-none text-xs font-bold text-center text-amber-500">
                        <option value="قيد العرض">قيد العرض</option>
                        <option value="تم الحفظ">تم الحفظ</option>
                        <option value="إحالة للمحكمة">إحالة للمحكمة</option>
                        <option value="استيفاء">استيفاء</option>
                    </select>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-slate-400 text-xs font-black flex items-center gap-2 mb-2">
                    <i data-lucide="users" class="w-4 h-4"></i> بيانات الأطراف
                </h2>
                <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">اسم الموكل</label><input type="text" id="commonClientName" placeholder="الاسم الكامل للموكل" class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 mr-2">صفة الموكل</label>
                    <div id="role-container" class="grid grid-cols-2 gap-2 p-1.5 bg-[#1e293b] rounded-2xl border border-slate-800"></div>
                    <input type="hidden" id="commonClientRole" value="">
                </div>

                <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">اسم الخصم</label><input type="text" id="commonOpponentName" placeholder="الاسم الكامل للخصم" class="w-full bg-transparent outline-none text-sm font-bold text-center text-slate-400"></div>
                <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">التهمة / موضوع السجل</label><input type="text" id="commonCharge" placeholder="تبديد، ضرب، دعوى نفقة..." class="w-full bg-transparent outline-none text-sm font-bold text-center"></div>
                <div class="input-box rounded-2xl p-3"><label class="block text-[9px] text-slate-500 mb-1">الموضوع (تفصيلي)</label><textarea id="commonSubject" rows="3" placeholder="ملاحظات وتفاصيل إضافية..." class="w-full bg-transparent outline-none text-sm leading-relaxed"></textarea></div>
                
                <div id="session-date-container" class="input-box rounded-2xl p-3">
                    <label class="block text-[9px] text-slate-500 mb-1">تاريخ الجلسة القادمة / التصرف</label>
                    <input type="date" id="commonDate" class="w-full bg-transparent outline-none text-xs font-bold text-center text-amber-500">
                </div>
            </div>

            <!-- قسم رفع الملفات -->
            <div class="bg-slate-900 border border-slate-700 rounded-3xl p-5 space-y-4">
                <h2 class="text-xs font-black text-slate-400 flex items-center gap-2">
                    <i data-lucide="image" class="w-4 h-4"></i> إرفاق صور / مستندات
                </h2>
                <div class="flex items-center justify-center w-full">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-700 border-dashed rounded-2xl cursor-pointer bg-slate-800/50 hover:bg-slate-800 transition-all">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-slate-500 mb-2"></i>
                            <p class="text-[10px] text-slate-400 font-bold">اضغط لاختيار الصور من جهازك</p>
                        </div>
                        <input type="file" id="fileUpload" class="hidden" multiple accept="image/*" onchange="handleFileSelect(event)" />
                    </label>
                </div>
                <div id="file-preview-container" class="grid grid-cols-4 gap-2 mt-2"></div>
            </div>

            <!-- التنبيهات -->
            <div class="bg-blue-600/5 border border-blue-500/20 rounded-[2rem] p-5 space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div id="alarm-indicator" class="w-2 h-2 rounded-full bg-slate-600"></div>
                        <span class="text-[11px] font-black text-blue-400">ضبط منبه تلقائي</span>
                    </div>
                    <button type="button" onclick="toggleAlarm()" id="alarm-btn" class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 transition-all flex items-center gap-2">
                        <i data-lucide="bell-off" id="alarm-icon" class="w-4 h-4 text-slate-500"></i>
                        <span id="alarm-text-btn" class="text-[10px] font-bold text-slate-500">معطل</span>
                    </button>
                </div>
                <div id="alarm-inputs" class="grid grid-cols-2 gap-3 opacity-30 pointer-events-none transition-all scale-95 origin-top">
                    <div class="input-box rounded-xl p-3"><label class="block text-[8px] text-slate-500 mb-1">يوم التنبيه</label><input type="date" id="alertDay" class="w-full bg-transparent outline-none text-[10px] text-center"></div>
                    <div class="input-box rounded-xl p-3"><label class="block text-[8px] text-slate-500 mb-1">ساعة التنبيه</label><input type="time" id="alertTime" class="w-full bg-transparent outline-none text-[10px] text-center"></div>
                </div>
                <input type="hidden" id="isAlarmActive" value="false">
            </div>

            <button onclick="saveItem()" class="w-full bg-gradient-to-r from-amber-600 to-amber-700 text-white font-black py-5 rounded-[2rem] shadow-2xl flex items-center justify-center gap-3 text-lg active:scale-95 transition-all">
                <i data-lucide="save"></i> حفظ البيانات بالكامل
            </button>
        </div>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-6 left-6 right-6 z-[100] bg-[#1e293b]/80 backdrop-blur-xl border border-slate-700/50 h-20 rounded-[2.5rem] shadow-2xl flex items-center justify-around px-4 no-print">
        <button onclick="setFilter('حالية')" id="nav-حالية" class="flex flex-col items-center gap-1 nav-active transition-all">
            <i data-lucide="briefcase" class="w-6 h-6"></i>
            <span class="text-[9px] font-bold">الحالية</span>
        </button>
        <button onclick="setFilter('مداولة')" id="nav-مداولة" class="flex flex-col items-center gap-1 text-slate-500 transition-all">
            <i data-lucide="refresh-cw" class="w-6 h-6"></i>
            <span class="text-[9px] font-bold">مداولة</span>
        </button>
        <button onclick="setFilter('منتهية')" id="nav-منتهية" class="flex flex-col items-center gap-1 text-slate-500 transition-all">
            <i data-lucide="check-circle-2" class="w-6 h-6"></i>
            <span class="text-[9px] font-bold">المنتهية</span>
        </button>
    </nav>

    <!-- حاوية الطباعة -->
    <div id="print-container" class="print-only"></div>

    <script>
        async function exportToPDF(id) {
    const item = db[currentCategory].find(i => i.id === id);
    if (!item) return;

    // إظهار رسالة انتظار بسيطة
    const btn = event.currentTarget;
    const originalVisible = btn.innerHTML;
    btn.innerHTML = "⏳";

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // 1. إنشاء عنصر مؤقت للرسم (Hidden Template)
        const tempDiv = document.createElement('div');
        tempDiv.style.width = '800px';
        tempDiv.style.padding = '40px';
        tempDiv.style.background = '#fff';
        tempDiv.style.color = '#000';
        tempDiv.style.fontFamily = 'Arial, sans-serif';
        tempDiv.setAttribute('dir', 'rtl');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';

        const isCase = item.category === 'cases';
        
        // 2. تصميم محتوى التقرير (HTML)
        tempDiv.innerHTML = `
            <div style="border: 4px double #c5a059; padding: 30px; border-radius: 15px;">
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px;">
                    <h1 style="color: #c5a059; margin: 0; font-size: 28px;">المستشار أحمد الألفي</h1>
                    <p style="margin: 5px 0; color: #666; font-weight: bold;">نظام الإدارة القانونية الذكي</p>
                </div>
                
                <h2 style="text-align: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    ${isCase ? 'تقرير ملف قضية' : 'تقرير ملف محضر'}
                </h2>
<table style="width: 50%; border-collapse: collapse; margin-top: 10px; font-size: 16px;">
    <tr>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; width: 30%; color: #444;"><b>اسم الموكل:</b></td>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; font-weight: bold;">${item.clientName}</td>
    </tr>
    <tr>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; color: #444;"><b>الصفة:</b></td>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; text-align: left;">${item.clientRole}</td>
    </tr>
    <tr>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; color: #444;"><b>الخصم:</b></td>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; text-align: left;">${item.opponentName || '---'}</td>
    </tr>
    <tr>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; color: #444;"><b>${isCase ? 'رقم القضية:' : 'رقم المحضر:'}</b></td>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; color: #c5a059; font-weight: bold;">${isCase ? item.caseNumber : item.reportAridatNum}</td>
    </tr>
    <tr>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; color: #444;"><b>الدائرة/النوع:</b></td>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; text-align: left;">${isCase ? item.circuit : item.reportType}</td>
    </tr>
    <tr>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; color: #444;"><b>التاريخ:</b></td>
        <td style="padding: 4px 10px; border-bottom: 1px solid #f0f0f0; text-align: left;">${item.date || '---'}</td>
    </tr>
</table>

                <div style="margin-top: 30px; padding: 15px; background: #fffcf5; border-right: 5px solid #c5a059;">
                    <h3 style="margin-top: 0;">الموضوع / التهمة:</h3>
                    <p style="line-height: 1.6;">${item.charge || item.subject || 'لا يوجد تفاصيل إضافية'}</p>
                </div>
            </div>
        `;

        document.body.appendChild(tempDiv);

        // 3. تحويل الـ HTML إلى صورة عالية الجودة
        const canvas = await html2canvas(tempDiv, { scale: 2 });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        
        // إضافة الصورة للـ PDF
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

        // 4. التعامل مع الصور المرفقة (كل صورة في صفحة جديدة)
        if (item.attachments && item.attachments.length > 0) {
            for (const fileData of item.attachments) {
                doc.addPage();
                // وضع المرفق ليملأ الصفحة
                doc.addImage(fileData, 'JPEG', 10, 10, 190, 277);
            }
        }

        doc.save(`تقرير_${item.clientName}.pdf`);
        document.body.removeChild(tempDiv);

    } catch (error) {
        console.error("PDF Error:", error);
        alert("حدث خطأ أثناء تصدير الملف");
    } finally {
        btn.innerHTML = originalVisible;
    }
}
        let db = JSON.parse(localStorage.getItem('lawyer_master_pro')) || { cases: [], reports: [] };
        let currentCategory = 'cases';
        let currentFilter = 'حالية';
        let editId = null;
        let tempFiles = [];

        function exportDatabase() {
            if (db.cases.length === 0 && db.reports.length === 0) {
                alert("لا توجد بيانات لتصديرها.");
                return;
            }
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Lawyer_Pro_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm("سيتم استبدال البيانات الحالية، هل أنت متأكد؟")) {
                        db = imported;
                        localStorage.setItem('lawyer_master_pro', JSON.stringify(db));
                        renderDisplay();
                    }
                } catch (err) { alert("خطأ في قراءة الملف"); }
            };
            reader.readAsText(file);
        }

        function switchCategory(cat) {
    currentCategory = cat;
    const btnCases = document.getElementById('cat-cases');
    const btnReports = document.getElementById('cat-reports');
    const caseFields = document.getElementById('case-fields');
    const reportFields = document.getElementById('report-fields');

    if(cat === 'cases') {
        // تحديث الأزرار
        btnCases.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all bg-amber-600 text-white shadow-lg";
        btnReports.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-500";
        // إظهار حقول القضايا وإخفاء المحاضر
        if(caseFields) caseFields.classList.remove('hidden');
        if(reportFields) reportFields.classList.add('hidden');
    } else {
        // تحديث الأزرار
        btnReports.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all bg-blue-600 text-white shadow-lg";
        btnCases.className = "flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-500";
        // إظهار حقول المحاضر وإخفاء القضايا
        if(caseFields) caseFields.classList.add('hidden');
        if(reportFields) reportFields.classList.remove('hidden');
    }
    
    updateRoleButtons();
    renderDisplay();

        }

        function updateRoleButtons() {
            const container = document.getElementById('role-container');
            const roles = currentCategory === 'cases' ? ['مدعي', 'مدعي عليه', 'متهم', 'مجني عليه'] : ['شاكي', 'مشكو في حقه', 'مجني عليه', 'مبلغ'];
            container.innerHTML = roles.map(r => `
                <button onclick="setRole('${r}')" id="role-${r}" class="py-2.5 rounded-xl text-[10px] font-bold transition-all bg-slate-800 text-slate-400 border border-transparent">
                    ${r}
                </button>
            `).join('');
        }

        function setRole(role) {
            document.getElementById('commonClientRole').value = role;
            document.querySelectorAll('#role-container button').forEach(b => b.classList.remove('tab-button-active'));
            const btn = document.getElementById(`role-${role}`);
            if(btn) btn.classList.add('tab-button-active');
        }

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-active');
                b.classList.add('text-slate-500');
            });
            document.getElementById(`nav-${f}`).classList.add('nav-active');
            document.getElementById(`nav-${f}`).classList.remove('text-slate-500');
            renderDisplay();
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempFiles.push(e.target.result);
                    updateFilePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateFilePreview() {
            const container = document.getElementById('file-preview-container');
            container.innerHTML = tempFiles.map((f, index) => `
                <div class="relative w-full h-16 rounded-lg overflow-hidden border border-slate-600">
                    <img src="${f}" class="w-full h-full object-cover">
                    <button onclick="removeFile(${index})" class="absolute top-0 right-0 bg-red-600 text-white p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function removeFile(idx) {
            tempFiles.splice(idx, 1);
            updateFilePreview();
        }

        function handleHeaderButtonClick() {
            const addSec = document.getElementById('add-section');
            if(!addSec.classList.contains('hidden')) toggleUI('list'); else toggleUI('add');
        }

        function toggleUI(view) {
            const list = document.getElementById('list-section');
            const add = document.getElementById('add-section');
            const search = document.getElementById('search-area');
            const icon = document.getElementById('header-icon');
            
            if(view === 'add') {
                list.classList.add('hidden'); search.classList.add('hidden'); add.classList.remove('hidden');
                icon.style.transform = "rotate(45deg)"; icon.classList.replace('text-amber-500', 'text-red-500');
                if(!editId) resetForm();
            } else {
                list.classList.remove('hidden'); search.classList.remove('hidden'); add.classList.add('hidden');
                icon.style.transform = "rotate(0deg)"; icon.classList.replace('text-red-500', 'text-amber-500');
                editId = null;
                renderDisplay();
            }
            lucide.createIcons();
        }

        function resetForm() {
            const inputs = document.querySelectorAll('#add-section input, #add-section textarea, #add-section select');
            inputs.forEach(i => i.value = '');
            document.getElementById('isAlarmActive').value = 'false';
            tempFiles = [];
            updateFilePreview();
            updateRoleButtons();
        }

        function toggleAlarm() {
            const isActive = document.getElementById('isAlarmActive').value === 'true';
            const newVal = !isActive;
            document.getElementById('isAlarmActive').value = newVal;
            
            const btn = document.getElementById('alarm-btn');
            const icon = document.getElementById('alarm-icon');
            const text = document.getElementById('alarm-text-btn');
            const inputs = document.getElementById('alarm-inputs');
            const indicator = document.getElementById('alarm-indicator');

            if(newVal) {
                btn.className = "bg-blue-600 px-4 py-2 rounded-full border border-blue-400 shadow-lg shadow-blue-900/40 flex items-center gap-2";
                icon.className = "w-4 h-4 text-white"; icon.setAttribute('data-lucide', 'bell');
                text.innerText = "مفعل"; text.className = "text-[10px] font-bold text-white";
                inputs.style.opacity = "1"; inputs.style.pointerEvents = "auto"; inputs.style.transform = "scale(1)";
                indicator.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
            } else {
                btn.className = "bg-slate-800 px-4 py-2 rounded-full border border-slate-700 flex items-center gap-2";
                icon.className = "w-4 h-4 text-slate-500"; icon.setAttribute('data-lucide', 'bell-off');
                text.innerText = "معطل"; text.className = "text-[10px] font-bold text-slate-500";
                inputs.style.opacity = "0.3"; inputs.style.pointerEvents = "none"; inputs.style.transform = "scale(0.95)";
                indicator.className = "w-2 h-2 rounded-full bg-slate-600";
            }
            lucide.createIcons();
        }

        function saveItem() {
            const client = document.getElementById('commonClientName').value.trim();
            const role = document.getElementById('commonClientRole').value;
            if(!client || !role) return alert("يرجى إدخال اسم الموكل وصفته");

            const item = {
                id: editId || Date.now().toString(),
                category: currentCategory,
                status: currentFilter,
                clientName: client,
                clientRole: role,
                opponentName: document.getElementById('commonOpponentName').value,
                charge: document.getElementById('commonCharge').value,
                subject: document.getElementById('commonSubject').value,
                date: document.getElementById('commonDate').value,
                isAlarm: document.getElementById('isAlarmActive').value,
                alertDay: document.getElementById('alertDay').value,
                alertTime: document.getElementById('alertTime').value,
                caseNumber: document.getElementById('caseNumber').value,
                hasrNumber: document.getElementById('hasrNumber').value,
                appealNumber: document.getElementById('appealNumber').value,
                court: document.getElementById('court').value,
                circuit: document.getElementById('circuit').value,
                reportAridatNum: document.getElementById('reportAridatNum').value,
                reportAridatDate: document.getElementById('reportAridatDate').value,
                reportType: document.getElementById('reportTypeInput').value,
                reportLegalNum: document.getElementById('reportLegalNum').value,
                niyabaDecision: document.getElementById('reportNiyabaDecision').value,
                attachments: [...tempFiles]
            };

            if(editId) {
                const idx = db[currentCategory].findIndex(i => i.id === editId);
                db[currentCategory][idx] = item;
            } else {
                db[currentCategory].unshift(item);
            }

            localStorage.setItem('lawyer_master_pro', JSON.stringify(db));
            toggleUI('list');
        }

        function renderDisplay() {
    const container = document.getElementById('cards-container');
    const searchInput = document.getElementById('searchInput');
    if (!container || !searchInput) return;

    const search = searchInput.value.toLowerCase();
    
    // ترتيب البيانات: الأقرب تاريخاً أولاً
    const data = db[currentCategory].filter(i => 
        i.status === currentFilter && 
        (i.clientName.toLowerCase().includes(search) || 
         (i.caseNumber && i.caseNumber.includes(search)) || 
         (i.reportAridatNum && i.reportAridatNum.includes(search)))
    ).sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(a.date) - new Date(b.date);
    });

    document.getElementById('items-count').innerText = `${data.length} سجل`;
    
    if(data.length === 0) {
        container.innerHTML = `<div class="py-20 text-center text-slate-500 font-bold italic">لا توجد سجلات حالياً في هذا القسم</div>`;
        return;
    }

    const today = new Date().toISOString().split('T')[0];

    container.innerHTML = data.map(i => {
        const isToday = i.date === today;
        const isCase = i.category === 'cases';

        return `
        <div class="relative group mb-6 transition-all duration-300 hover:translate-y-[-5px]">
            ${isToday ? '<div class="absolute -inset-1 bg-gradient-to-r from-red-600 to-orange-600 rounded-2xl blur opacity-25 animate-pulse"></div>' : ''}
            
            <div class="relative bg-slate-900/80 backdrop-blur-xl border ${isToday ? 'border-red-500' : 'border-slate-700/50'} rounded-2xl p-5 shadow-2xl">
                
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <span class="flex items-center gap-1 px-3 py-1 rounded-full text-[10px] font-black tracking-tighter ${isToday ? 'bg-red-500 text-white animate-bounce' : 'bg-slate-800 text-slate-400'}">
                            ${isToday ? '● جلسة اليوم' : (isCase ? 'ملف قضية' : 'ملف محضر')}
                        </span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editItem('${i.id}')" class="p-2 text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors" title="تعديل">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                            <button onclick="event.stopPropagation(); exportToPDF('${i.id}')" class="p-2 text-emerald-400 hover:bg-emerald-400/10 rounded-lg transition-colors" title="تحميل PDF">
        <i data-lucide="file-text" class="w-4 h-4"></i>
    </button>
                        </button>
                        <button onclick="deleteItem('${i.id}')" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition-colors" title="حذف">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-5">
                    <p class="text-[10px] text-amber-500 font-bold mb-1 opacity-80">اسم الموكل (${i.clientRole})</p>
                    <h3 class="text-xl font-black text-white drop-shadow-sm">${i.clientName}</h3>
                </div>

                <div class="grid grid-cols-2 gap-4 border-t border-slate-800 pt-4">
                    <div>
                        <p class="text-[9px] text-slate-500 font-bold mb-1">الخصم</p>
                        <p class="text-[11px] font-bold text-slate-200 truncate">${i.opponentName || 'غير متوفر'}</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-slate-500 font-bold mb-1">${isCase ? 'رقم القضية' : 'رقم المحضر'}</p>
                        <p class="text-[11px] font-black text-amber-500">${isCase ? (i.caseNumber || '---') : (i.reportAridatNum || '---')}</p>
                    </div>
                    <div class="col-span-1">
                        <p class="text-[9px] text-slate-500 font-bold mb-1">التهمة / الموضوع</p>
                        <p class="text-[11px] font-bold text-slate-300 truncate">${i.charge || i.subject || 'غير محدد'}</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-slate-500 font-bold mb-1">${isCase ? 'الدائرة' : 'النوع'}</p>
                        <p class="text-[20px] font-bold text-slate-300">${isCase ? (i.circuit || '---') : (i.reportType || '---')}</p>
                    </div>
                </div>

                <div class="mt-5 flex items-center justify-center gap-2 py-2.5 rounded-xl ${isToday ? 'bg-red-500/10 border border-red-500/10 text-red-500' : 'bg-slate-800/40 text-slate-500'}">
                    <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                    <span class="text-[15px] font-black uppercase">${isToday ? 'الموعد: اليـــوم' : (i.date || 'بدون موعد')}</span>
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    // إعادة تفعيل الأيقونات
    if (window.lucide) {
        lucide.createIcons();
    }

        }

        function editItem(id) {
            const item = db[currentCategory].find(i => i.id === id);
            if(!item) return;
            editId = id;
            toggleUI('add');
            document.getElementById('commonClientName').value = item.clientName;
            setRole(item.clientRole);
            document.getElementById('commonOpponentName').value = item.opponentName;
            document.getElementById('commonCharge').value = item.charge;
            document.getElementById('commonSubject').value = item.subject;
            document.getElementById('commonDate').value = item.date;
            document.getElementById('caseNumber').value = item.caseNumber || '';
            document.getElementById('hasrNumber').value = item.hasrNumber || '';
            document.getElementById('appealNumber').value = item.appealNumber || '';
            document.getElementById('court').value = item.court || '';
            document.getElementById('circuit').value = item.circuit || '';
            document.getElementById('reportAridatNum').value = item.reportAridatNum || '';
            document.getElementById('reportAridatDate').value = item.reportAridatDate || '';
            document.getElementById('reportTypeInput').value = item.reportType || '';
            document.getElementById('reportLegalNum').value = item.reportLegalNum || '';
            document.getElementById('reportNiyabaDecision').value = item.niyabaDecision || 'قيد العرض';
            tempFiles = item.attachments || [];
            updateFilePreview();
            if(item.isAlarm === 'true') toggleAlarm();
        }

        function deleteItem(id) {
            if(confirm("حذف السجل نهائياً؟")) {
                db[currentCategory] = db[currentCategory].filter(i => i.id !== id);
                localStorage.setItem('lawyer_master_pro', JSON.stringify(db));
                renderDisplay();
            }
        }

        function printItem(id) {
            const item = db[currentCategory].find(i => i.id === id);
            if(!item) return;
            const container = document.getElementById('print-container');
            
            let html = `
                <div class="print-page">
                    <div class="print-header">
                        <h1 style="font-size: 24px; font-weight: 900; margin-bottom: 5px;">مكتب المستشار أحمد الألفي المحامي</h1>
                        <p style="font-size: 14px; font-weight: bold;">تقرير بيانات ${item.category === 'cases' ? 'قضية' : 'محضر'}</p>
                    </div>
                    <div class="print-grid">
                        <div class="print-item"><span class="print-label">الموكل:</span> <span>${item.clientName}</span></div>
                        <div class="print-item"><span class="print-label">الصفة:</span> <span>${item.clientRole}</span></div>
                        <div class="print-item"><span class="print-label">الخصم:</span> <span>${item.opponentName || '---'}</span></div>
                        <div class="print-item"><span class="print-label">رقم ${item.category === 'cases' ? 'القضية' : 'العريضة'}:</span> <span>${item.category === 'cases' ? item.caseNumber : item.reportAridatNum}</span></div>
                        <div class="print-item"><span class="print-label">المحكمة / الجهة:</span> <span>${item.court || '---'}</span></div>
                        <div class="print-item"><span class="print-label">${item.category === 'cases' ? 'الدائرة' : 'نوع المحضر'}:</span> <span>${item.category === 'cases' ? item.circuit : item.reportType}</span></div>
                        <div class="print-item"><span class="print-label">التهمة / الموضوع:</span> <span>${item.charge || '---'}</span></div>
                        <div class="print-item"><span class="print-label">الجلسة القادمة:</span> <span>${item.date || '---'}</span></div>
                    </div>
                    <div style="margin-top: 20px; border-top: 1px solid #000; padding-top: 10px;">
                        <p class="print-label">تفاصيل إضافية:</p>
                        <p style="white-space: pre-wrap; font-size: 12px; margin-top: 10px;">${item.subject || 'لا يوجد ملاحظات'}</p>
                    </div>
                </div>
            `;

            if(item.attachments && item.attachments.length > 0) {
                item.attachments.forEach(img => {
                    html += `
                        <div class="image-page">
                            <img src="${img}">
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
            window.print();
        }

        function checkAlarms() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().slice(0, 5);
            
            [...db.cases, ...db.reports].forEach(item => {
                if(item.isAlarm === 'true' && item.alertDay === todayStr && item.alertTime === timeStr) {
                    const banner = document.getElementById('alarm-banner');
                    document.getElementById('alarm-text').innerText = `موعد: ${item.clientName} - ${item.charge}`;
                    banner.classList.remove('hidden');
                }
            });
        }

        function dismissAlarm() {
            document.getElementById('alarm-banner').classList.add('hidden');
        }

        setInterval(checkAlarms, 60000);
       window.onload = () => {
    // 1. تحديث أزرار الصفة (مدعي/مدعى عليه)
    if (typeof updateRoleButtons === 'function') updateRoleButtons();
    
    // 2. عرض كروت القضايا والمحاضر
    if (typeof renderDisplay === 'function') renderDisplay();

    // 3. الأمر السحري: رسم الأيقونات فوراً في كامل الصفحة
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
        };
    </script>
</body>
</html>